#!/bin/bash

# NhanHoaRD Team - 04/02/2021
# Script update sudo de xu ly CVE-2021-3156
# Update sudo to 1.9.5-3
# Cac distro ho tro: Ubuntu 16.04, Ubuntu 18.04, Ubuntu 20.04, CentOS 6, CentOS 7 , CentOS 8, Debian 9, Debian 10, Cloud Linux 7
# Cach su dung: bash update_sudo_CVE-2021-3156.sh


# Variable Color text
RED="\033[1;31m"
GREEN="\033[1;32m"
NOCOLOR="\033[0m"

# Kiem tra quyen root
[[ $EUID -ne 0 ]] && echo -e "${RED}ERROR:${PLAIN} Script can duoc thuc hien duoi quyen root!" && exit 1

# Link tai goi cai dat sudo 1.9.5-3 cho tung OS
u16_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo_1.9.5-3_ubu1604_amd64.deb"
u18_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo_1.9.5-3_ubu1804_amd64.deb"
u20_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo_1.9.5-3_ubu2004_amd64.deb"
c6_url="--no-check-certificate https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo-1.9.5-3.el6.x86_64.rpm"
c7_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo-1.9.5-3.el7.x86_64.rpm"
c8_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo-1.9.5-3.el8.x86_64.rpm"
deb9_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo_1.9.5-3_deb9_amd64.deb"
deb10_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo_1.9.5-3_deb10_amd64.deb"
cl7_url="https://github.com/sudo-project/sudo/releases/download/SUDO_1_9_5p2/sudo-1.9.5-3.el7.x86_64.rpm"

# Lay ten OS
get_os_name() {
    if [ -f /etc/redhat-release ]; then
        OS_NAME=`awk '{print ($1,$3~/^[0-9]/?$3:$4)}' /etc/redhat-release`
    elif [ -f /etc/os-release ]; then
        OS_NAME=`awk -F'[= "]' '/PRETTY_NAME/{print $3,$4,$5}' /etc/os-release`
        OS_VERSION=`awk -F= '/^VERSION_CODENAME/{print $2}' /etc/os-release`
    elif [ -f /etc/lsb-release ]; then
        OS_NAME=`awk -F'[="]+' '/DESCRIPTION/{print $2}' /etc/lsb-release`
    else
        echo -e "${RED}OS khong duoc ho tro!!!${NOCOLOR}"
    fi
}

# Update sudo cho ho Debian
update_debian() {
    echo -e "${GREEN}>>> Version sudo hien tai:${NOCOLOR}"
    dpkg -l | grep sudo
    echo "Updating..."
    apt-get install -y wget > /dev/null 2>&1
    wget -q -O "sudo_1.9.5.deb" $URL
    dpkg -i sudo_1.9.5.deb
    echo -e "${GREEN}======================================${NOCOLOR}"
    echo -e "${GREEN}>>> Sudo version sau khi update:${NOCOLOR}"
    dpkg -l | grep sudo
    rm -rf sudo_1.9.5.deb
}

# Update sudo cho ho RHEL
update_rhel() {
    echo -e "${GREEN}>>> Version sudo hien tai:${NOCOLOR}"
    rpm -qa | grep sudo
    echo "Updating..."
    yum install -y wget > /dev/null 2>&1
    wget -q -O sudo_1.9.5.rpm $URL
    rpm -Uvh sudo_1.9.5.rpm 
    echo -e "${GREEN}======================================${NOCOLOR}"
    echo -e "${GREEN}>>> Sudo version sau khi update:${NOCOLOR}"
    rpm -qa | grep sudo
    rm -rf sudo_1.9.5.rpm
}

################################################################################
main() {
    get_os_name

    # Kiem tra & update goi sudo
    if [[ $OS_NAME == *"Ubuntu"* ]]; then
        echo -e "${GREEN}======================================${NOCOLOR}"
        echo $OS_NAME $OS_VERSION
        if [[ $OS_VERSION = "bionic" ]]; then
            URL=$u18_url
            update_debian
        elif [[ $OS_VERSION = "xenial" ]]; then
            URL=$u16_url
            update_debian
        elif [[ $OS_VERSION = "focal" ]]; then
            URL=$u20_url
            update_debian
        else
            echo -e "${RED}$OS_VERSION khong duoc ho tro!${NOCOLOR}"
        fi
    elif [[ $OS_NAME == *"Debian"* ]]; then
        echo -e "${GREEN}======================================${NOCOLOR}"
        echo $OS_NAME $OS_VERSION
        if [[ $OS_VERSION = "stretch" ]]; then
            URL=$deb9_url
            update_debian
        elif [[ $OS_VERSION = "buster" ]]; then
            URL=$deb10_url
            update_debian
        else
            echo -e "${RED}$OS_VERSION khong duoc ho tro!${NOCOLOR}"
        fi
    elif [[ $OS_NAME == *"CentOS"* ]]; then
        echo -e "${GREEN}======================================${NOCOLOR}"
        echo $OS_NAME
        if [[ $OS_NAME == *"CentOS 6"* ]]; then
            URL=$c6_url
            update_rhel
        elif [[ $OS_NAME == *"CentOS 7"* ]]; then
            URL=$c7_url
            update_rhel
        elif [[ $OS_NAME == *"CentOS 8"* ]]; then
            URL=$c8_url
            update_rhel
        else
            echo -e "${RED}$OS_NAME khong duoc ho tro!${NOCOLOR}"
        fi   
    elif [[ $OS_NAME == *"CloudLinux"* ]]; then
        echo -e "${GREEN}======================================${NOCOLOR}"
        echo $OS_NAME
        if [[ $OS_NAME == *"CloudLinux 7"* ]]; then
            URL=$cl7_url
            update_rhel
        else
            echo -e "${RED}$OS_NAME khong duoc ho tro!${NOCOLOR}"
        fi
    else
        echo -e "${RED}$OS_NAME $OS_VERSION  khong duoc ho tro!${NOCOLOR}"
    fi
}

# RUN SCRIPT
main
exit
